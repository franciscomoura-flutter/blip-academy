<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blip Academy CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        [x-cloak] {
            display: none !important;
        }

        .table-cell-max {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
        }

        .sortable-header:hover {
            background-color: #f9fafb;
        }

        .draggable-field {
            cursor: move;
        }

        .draggable-field:hover {
            background-color: #f9fafb;
        }

        .drag-over {
            border-top: 2px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900" id="project-name"></h1>
                    <span class="ml-3 text-sm text-gray-500">CMS</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="auth-user-chip" class="hidden items-center space-x-2">
                        <span id="auth-user-email" class="text-sm text-gray-600"></span>
                        <button id="signout-btn" onclick="window.authApp.signOut()"
                            class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>Sign out
                        </button>
                    </div>
                    <button onclick="window.cmsApp?.refreshView?.()"
                        class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Auth Gate -->
    <div id="auth-view" class="max-w-md w-full mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="auth-login-block">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Admin Sign in</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Only the configured admin account can sign in.
                </p>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input id="login-email" type="email" placeholder="admin@yourdomain.com"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input id="login-password" type="password" placeholder="Enter password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <button id="login-btn" onclick="window.authApp.signIn()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-right-to-bracket mr-2"></i>Sign in
                    </button>
                    <button id="reset-btn" onclick="window.authApp.resetPassword()"
                        class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-key mr-2"></i>Forgot password
                    </button>
                </div>
            </div>
            <div id="auth-status" class="mt-4 text-sm"></div>
        </div>
    </div>

    <!-- App -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="app" style="display: none;">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-gray-600">Loading collections...</p>
        </div>

        <!-- Collections View -->
        <div id="collections-view" style="display: none;">
            <!-- Add Collection -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Collection</h3>
                <div class="flex items-center space-x-3">
                    <input type="text" id="new-collection-name" placeholder="Collection name"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        onkeypress="if(event.key === 'Enter') window.cmsApp.createCollection()">
                    <button onclick="window.cmsApp.createCollection()"
                        class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Create Collection
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Collections</h2>
                    <span id="collections-count" class="text-sm text-gray-500"></span>
                </div>
                <div id="collections-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

        </div>

        <!-- Collection View -->
        <div id="collection-view" style="display: none;">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button onclick="window.cmsApp.backToCollections()"
                            class="mr-4 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div>
                            <h2 id="collection-title" class="text-2xl font-bold text-gray-900"></h2>
                        </div>
                        <span id="document-count"
                            class="ml-4 bg-gray-100 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded"></span>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="window.cmsApp.createNewDocument()"
                            class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Document
                        </button>
                        <button onclick="window.cmsApp.showImportModal()"
                            class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-file-import mr-2"></i>Import CSV
                        </button>
                        <button onclick="window.cmsApp.showCollectionSettings()"
                            class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-cog mr-2"></i>Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex space-x-4">
                    <input type="text" id="search-input" oninput="window.cmsApp.filterDocuments()"
                        placeholder="Search documents..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="search-field"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Search all fields</option>
                    </select>
                </div>
            </div>

            <!-- Batch Actions -->
            <div id="batch-actions-container" style="display: none;"></div>

            <!-- Documents Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="table-head" class="bg-gray-50"></thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Document Editor -->
        <div id="document-editor" style="display: none;">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <button onclick="window.cmsApp.backToCollection()"
                            class="mr-4 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 id="editor-title" class="text-2xl font-bold text-gray-900">Edit Document</h2>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="window.cmsApp.saveDocument()"
                            class="bg-green-500 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button onclick="window.cmsApp.backToCollection()"
                            class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="document-form" class="space-y-4"></div>

                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Field</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="new-field-name" placeholder="Field name"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <select id="new-field-type"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="dropdown">Dropdown</option>
                            <option value="map">Map</option>
                            <option value="array">Array</option>
                            <option value="null">Null</option>
                            <option value="timestamp">Timestamp</option>
                            <option value="geopoint">Geopoint</option>
                            <option value="reference">Reference</option>
                        </select>
                        <button onclick="window.cmsApp.addNewFieldWithType()"
                            class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i>Add Field
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Settings Modal -->
        <div id="collection-settings-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4"
            style="display: none;">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-xl font-medium text-gray-900">Collection Template Settings</h3>
                    <button onclick="window.cmsApp.hideCollectionSettings()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto flex-1">
                    <p class="text-sm text-gray-600 mb-6">
                        Define the fields, their display names, types, and order for documents in this collection.
                        Drag fields to reorder them.
                    </p>

                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Field Template</h4>
                        <div id="template-fields-list" class="space-y-2 mb-4"></div>
                    </div>

                    <div class="border-t pt-6">
                        <h4 class="text-md font-medium text-gray-900 mb-3">Add New Field to Template</h4>
                        <div class="grid grid-cols-4 gap-3">
                            <input type="text" id="template-field-name" placeholder="Field name (e.g., title)"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="template-field-display" placeholder="Display name (e.g., Title)"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <select id="template-field-type"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="string">String</option>
                                <option value="number">Number</option>
                                <option value="boolean">Boolean</option>
                                <option value="dropdown">Dropdown</option>
                                <option value="map">Map</option>
                                <option value="array">Array</option>
                                <option value="timestamp">Timestamp</option>
                                <option value="geopoint">Geopoint</option>
                                <option value="reference">Reference</option>
                            </select>
                            <button onclick="window.cmsApp.addTemplateField()"
                                class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Add
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 border-t p-6">
                    <button onclick="window.cmsApp.hideCollectionSettings()"
                        class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button onclick="window.cmsApp.saveCollectionSettings()"
                        class="bg-green-500 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Template
                    </button>
                </div>
            </div>
        </div>

        <!-- CSV Import Modal -->
        <div id="csv-import-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4"
            style="display: none;">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-xl font-medium text-gray-900">Import CSV File</h3>
                    <button onclick="window.cmsApp.hideImportModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Step 1: File Upload -->
                    <div id="import-step-1" class="space-y-4">
                        <h4 class="text-lg font-medium text-gray-900">Step 1: Select CSV File</h4>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="csv-file-input" accept=".csv"
                                onchange="window.cmsApp.handleCSVFile(event)" class="hidden">
                            <button onclick="document.getElementById('csv-file-input').click()"
                                class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                                <i class="fas fa-upload mr-2"></i>Choose CSV File
                            </button>
                            <p class="mt-2 text-sm text-gray-500">
                                Select a CSV file to import. First row should contain column headers.
                            </p>
                        </div>
                        <div id="csv-file-info" class="hidden bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-file-csv text-green-500 mr-2"></i>
                                <span id="csv-file-name" class="font-medium"></span>
                                <span id="csv-file-size" class="ml-2 text-sm text-gray-500"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Field Mapping -->
                    <div id="import-step-2" class="space-y-4" style="display: none;">
                        <h4 class="text-lg font-medium text-gray-900">Step 2: Map CSV Columns to Template Fields</h4>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <p>Map your CSV columns to collection template fields. Unmapped columns will be
                                        ignored.</p>
                                    <p class="mt-1">Fields marked with <span class="text-red-600">*</span> are required
                                        template fields.</p>
                                </div>
                            </div>
                        </div>

                        <div id="csv-preview" class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-2 border-b">
                                <h5 class="font-medium text-gray-900">CSV Preview (first 3 rows)</h5>
                            </div>
                            <div id="csv-preview-content" class="p-4 overflow-x-auto"></div>
                        </div>

                        <div id="field-mapping" class="space-y-3">
                            <h5 class="font-medium text-gray-900">Field Mapping</h5>
                            <div id="field-mapping-list" class="space-y-2"></div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2 mt-0.5"></i>
                                <div class="text-sm text-yellow-800">
                                    <p><strong>Import Notes:</strong></p>
                                    <ul class="mt-1 list-disc list-inside space-y-1">
                                        <li>Empty CSV cells will be saved as null values</li>
                                        <li>Boolean fields: use "true/false", "yes/no", or "1/0"</li>
                                        <li>Number fields: ensure valid numeric values</li>
                                        <li>Timestamp fields: use ISO format (YYYY-MM-DDTHH:mm:ss) or standard date
                                            formats</li>
                                        <li>Array fields: use JSON array format ["item1", "item2"] or comma-separated
                                            values</li>
                                        <li>Map/Object fields: use valid JSON format</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Import Progress -->
                    <div id="import-step-3" class="space-y-4" style="display: none;">
                        <h4 class="text-lg font-medium text-gray-900">Step 3: Importing Data</h4>

                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-900">Import Progress</span>
                                <span id="import-progress-text" class="text-sm text-blue-700">0 / 0</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="import-progress-bar"
                                    class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%">
                                </div>
                            </div>
                        </div>

                        <div id="import-status" class="space-y-2">
                            <div class="text-sm text-gray-600">
                                <div id="import-success-count" class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>Successfully imported: <span class="font-medium">0</span> documents</span>
                                </div>
                                <div id="import-error-count" class="flex items-center">
                                    <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                                    <span>Errors: <span class="font-medium">0</span> documents</span>
                                </div>
                            </div>
                        </div>

                        <div id="import-errors" class="hidden">
                            <h5 class="font-medium text-red-900 mb-2">Import Errors:</h5>
                            <div id="import-errors-list" class="space-y-1 max-h-40 overflow-y-auto"></div>
                        </div>

                        <div id="import-complete" class="hidden bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-green-800 font-medium">Import completed successfully!</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t p-6">
                    <button id="import-back-btn" onclick="window.cmsApp.importPreviousStep()"
                        class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-2 rounded-lg" style="display: none;">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <div class="flex space-x-3 ml-auto">
                        <button onclick="window.cmsApp.hideImportModal()"
                            class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                            Cancel
                        </button>
                        <button id="import-next-btn" onclick="window.cmsApp.importNextStep()"
                            class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-lg" disabled>
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        <button id="import-start-btn" onclick="window.cmsApp.startImport()"
                            class="bg-green-500 hover:bg-green-700 text-white px-6 py-2 rounded-lg"
                            style="display: none;">
                            <i class="fas fa-play mr-2"></i>Start Import
                        </button>
                        <button id="import-finish-btn" onclick="window.cmsApp.finishImport()"
                            class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-2 rounded-lg"
                            style="display: none;">
                            <i class="fas fa-check mr-2"></i>Finish
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-message" style="display: none;"
            class="fixed bottom-4 right-4 max-w-sm w-full bg-white border-l-4 p-4 shadow-lg rounded-lg z-50">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i id="status-icon" class="fas"></i>
                </div>
                <div class="ml-3">
                    <p id="status-text" class="text-sm"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="window.cmsApp.hideStatus()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import {
            getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, setDoc,
            Timestamp, GeoPoint, deleteField, getDoc
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import {
            getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence,
            signInWithEmailAndPassword, signOut, sendPasswordResetEmail
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // ============================================
        // CONFIGURATION - Change for your project
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_B4V3E_h2VFGaESqBLIW2vzIQ2KYm5Bc",
            authDomain: "blip-academy.firebaseapp.com",
            projectId: "blip-academy",
            storageBucket: "blip-academy.firebasestorage.app",
            messagingSenderId: "821433951137",
            appId: "1:821433951137:web:73f9dc972e02f06604e1e0",
            measurementId: "G-JXFNC2M0CP"
        };

        const CMS_CONFIG = {
            trackerCollection: 'collectionList',
            projectName: 'Blip Academy'
        };

        // ============================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const els = {
            authView: document.getElementById('auth-view'),
            loginBlock: document.getElementById('auth-login-block'),
            authStatus: document.getElementById('auth-status'),
            appRoot: document.getElementById('app'),
            userChip: document.getElementById('auth-user-chip'),
            userEmail: document.getElementById('auth-user-email'),
            projectName: document.getElementById('project-name'),
        };

        let cmsStarted = false;

        function setStatus(text, type = 'info') {
            const color = type === 'error' ? 'text-red-700 bg-red-50 border-red-200'
                : type === 'success' ? 'text-green-700 bg-green-50 border-green-200'
                    : 'text-gray-700 bg-gray-50 border-gray-200';
            els.authStatus.className = `mt-4 text-sm px-3 py-2 rounded border ${color}`;
            els.authStatus.textContent = text;
        }

        function showLogin() {
            els.authView.style.display = 'block';
            els.appRoot.style.display = 'none';
            els.userChip.classList.add('hidden');
        }

        function showApp(user) {
            els.authView.style.display = 'none';
            els.appRoot.style.display = 'block';
            els.userChip.classList.remove('hidden');
            els.userEmail.textContent = user?.email || '';
        }

        async function ensurePersistence() {
            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (e) {
                console.warn('Failed to set auth persistence:', e);
            }
        }

        // Fixed function to check admin status
        async function isAuthorizedUser(user) {
            if (!user) return false;

            try {
                const adminDoc = await getDoc(doc(db, 'cmsConfig', 'admin'));
                if (adminDoc.exists()) {
                    return user.uid === adminDoc.data().adminUid;
                }

                setStatus('No admin config found. Create a document at cmsConfig/admin with field adminUid set to your user UID: ' + user.uid, 'error');
                return false;
            } catch (e) {
                console.error('Error checking admin status:', e);
                setStatus('Error checking admin permissions: ' + e.message, 'error');
                return false;
            }
        }

        async function startCMSIfNeeded() {
            if (cmsStarted) return;
            window.cmsApp = new UniversalCMS();
            await window.cmsApp.init();
            cmsStarted = true;
        }

        window.authApp = {
            async signIn() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                setStatus('Signing in...');
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);

                    // Check admin status after sign in
                    const isAdmin = await isAuthorizedUser(userCredential.user);
                    if (!isAdmin) {
                        await signOut(auth);
                        setStatus(`Not authorized as admin. Your UID: ${userCredential.user.uid}`, 'error');
                        return;
                    }

                    setStatus('Signed in as admin.', 'success');
                } catch (e) {
                    setStatus(e.message || 'Failed to sign in.', 'error');
                }
            },

            async resetPassword() {
                const email = document.getElementById('login-email').value.trim();
                if (!email) { setStatus('Enter the admin email to reset password.', 'error'); return; }
                try {
                    await sendPasswordResetEmail(auth, email);
                    setStatus('Password reset email sent.', 'success');
                } catch (e) {
                    setStatus(e.message || 'Failed to send reset email.', 'error');
                }
            },

            async signOut() {
                try {
                    await signOut(auth);
                    setStatus('Signed out.', 'success');
                    cmsStarted = false;
                    showLogin();
                } catch (e) {
                    setStatus(e.message || 'Failed to sign out.', 'error');
                }
            }
        };

        (async function boot() {
            els.projectName.textContent = CMS_CONFIG.projectName;
            await ensurePersistence();

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    showLogin();
                    return;
                }

                // Check admin status on each auth state change
                const isAdmin = await isAuthorizedUser(user);
                if (!isAdmin) {
                    await signOut(auth);
                    showLogin();
                    return;
                }

                setStatus('');
                showApp(user);
                await startCMSIfNeeded();
                await window.cmsApp.refreshView();
            });
        })();

        // ============================================
        // CMS implementation (unchanged features)
        // ============================================
        class UniversalCMS {
            constructor() {
                this.collections = [];
                this.documents = [];
                this.filteredDocuments = [];
                this.availableFields = [];
                this.documentForm = {};
                this.fieldTypes = {};
                this.currentDocument = null;
                this.currentCollection = null;
                this.isNewDocument = false;
                this.currentSortField = null;
                this.currentSortOrder = null;
                this.originalDocumentFields = new Set();
                this.fieldsToDelete = new Set();
                this.collectionTemplate = null;
                this.templateFields = [];
                this.draggedFieldIndex = null;
                this.csvData = null;
                this.csvHeaders = [];
                this.csvRows = [];
                this.fieldMapping = {};
                this.importStep = 1;
                this.importProgress = {
                    total: 0,
                    current: 0,
                    success: 0,
                    errors: 0,
                    errorDetails: []
                };
                // Batch selection properties
                this.selectedDocuments = new Set();
                this.showBatchActions = false;
            }

            async init() {
                document.getElementById('project-name').textContent = CMS_CONFIG.projectName;
                await this.loadCollections();
            }

            async loadCollections() {
                try {
                    const querySnapshot = await getDocs(collection(db, CMS_CONFIG.trackerCollection));
                    this.collections = [];
                    const collectionsToRemove = [];

                    for (const docSnap of querySnapshot.docs) {
                        const data = docSnap.data();

                        try {
                            const collectionSnapshot = await getDocs(collection(db, data.name));

                            if (collectionSnapshot.empty) {
                                // Collection is empty - mark for removal from tracker
                                collectionsToRemove.push(docSnap.id);
                                continue;
                            }

                            const count = collectionSnapshot.docs.filter(d => !d.data()._placeholder).length;

                            this.collections.push({
                                id: docSnap.id,
                                name: data.name,
                                count: count,
                                totalDocs: collectionSnapshot.docs.length,
                                createdAt: data.createdAt,
                                lastModified: data.lastModified || data.createdAt, // Use collection's lastModified or fallback to createdAt
                                template: data.template || null,
                                sortField: data.sortField || null,
                                sortOrder: data.sortOrder || null
                            });
                        } catch (error) {
                            // Collection doesn't exist or access error - mark for removal
                            collectionsToRemove.push(docSnap.id);
                        }
                    }

                    // Clean up orphaned tracker entries
                    for (const collectionId of collectionsToRemove) {
                        try {
                            await deleteDoc(doc(db, CMS_CONFIG.trackerCollection, collectionId));
                            console.log(`Cleaned up orphaned tracker entry: ${collectionId}`);
                        } catch (error) {
                            console.error(`Error cleaning up tracker entry ${collectionId}:`, error);
                        }
                    }

                    // Sort collections alphabetically by name
                    this.collections.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));

                    this.renderCollections();
                } catch (error) {
                    if (error.code === 'permission-denied' || (error.message || '').includes('Missing or insufficient permissions')) {
                        await this.initializeTrackerCollection();
                    } else {
                        this.showStatus('Error loading collections: ' + error.message, 'error');
                    }
                }
            }

            async initializeTrackerCollection() {
                try {
                    this.showStatus('Initializing collection tracker...', 'info');

                    await setDoc(doc(db, CMS_CONFIG.trackerCollection, 'welcome'), {
                        name: 'welcome',
                        createdAt: new Date().toISOString(),
                        _isWelcome: true
                    });

                    this.showStatus('Collection tracker initialized successfully!');
                    await this.loadCollections();
                } catch (error) {
                    this.showStatus('Error initializing tracker: ' + error.message, 'error');
                }
            }

            renderCollections() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('collections-view').style.display = 'block';

                document.getElementById('collections-count').textContent =
                    `${this.collections.length} ${this.collections.length === 1 ? 'collection' : 'collections'}`;

                const grid = document.getElementById('collections-grid');

                if (this.collections.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <i class="fas fa-database text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 mb-4">No collections yet</p>
                            <p class="text-sm text-gray-500">Create your first collection below to get started</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = this.collections.map(coll => {
                    const lastModifiedDate = coll.lastModified ? new Date(coll.lastModified) : null;
                    const createdDate = coll.createdAt ? new Date(coll.createdAt) : null;

                    return `
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer border"
                             onclick="window.cmsApp.selectCollection('${coll.id}')">
                            <!-- Title and Count -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <i class="fas fa-database text-blue-500 text-2xl mr-3"></i>
                                    <h3 class="text-lg font-medium text-gray-900">${coll.name}</h3>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${coll.template ? '<i class="fas fa-check-circle text-green-500" title="Template configured"></i>' : ''}
                                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded">
                                        ${coll.count}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Dates in one line -->
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                                ${createdDate ? `
                                    <div class="flex items-center">
                                        <span class="text-gray-400 mr-1">Created</span>
                                        <span class="text-gray-600">${createdDate.toLocaleDateString()}</span>
                                    </div>
                                ` : '<div></div>'}
                                ${lastModifiedDate ? `
                                    <div class="flex items-center">
                                        <span class="text-gray-400 mr-1">Last edited</span>
                                        <span class="text-gray-600">${lastModifiedDate.toLocaleDateString()}</span>
                                    </div>
                                ` : '<div></div>'}
                            </div>
                            
                            <!-- CTA -->
                            <div class="flex justify-start">
                                <span class="text-blue-600 text-sm font-medium">View Collection â†’</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async createCollection() {
                const name = document.getElementById('new-collection-name').value.trim();

                if (!name) {
                    this.showStatus('Please enter a collection name', 'error');
                    return;
                }

                if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(name)) {
                    this.showStatus('Collection name must start with a letter and contain only letters, numbers, and underscores', 'error');
                    return;
                }

                if (this.collections.find(c => c.name === name)) {
                    this.showStatus('Collection already exists', 'error');
                    return;
                }

                try {
                    await addDoc(collection(db, CMS_CONFIG.trackerCollection), {
                        name: name,
                        createdAt: new Date().toISOString(),
                        template: null
                    });

                    await addDoc(collection(db, name), {
                        _placeholder: true,
                        createdAt: new Date().toISOString(),
                        createdBy: 'CMS'
                    });

                    document.getElementById('new-collection-name').value = '';

                    this.showStatus('Collection created successfully!');
                    await this.loadCollections();
                } catch (error) {
                    this.showStatus('Error creating collection: ' + error.message, 'error');
                }
            }

            async selectCollection(collectionId) {
                const collInfo = this.collections.find(c => c.id === collectionId);
                if (!collInfo) return;

                this.currentCollection = collInfo;
                this.collectionTemplate = collInfo.template;

                // Load saved sort state from collection
                this.currentSortField = collInfo.sortField || null;
                this.currentSortOrder = collInfo.sortOrder || null;

                document.getElementById('collections-view').style.display = 'none';
                document.getElementById('loading-state').style.display = 'block';

                try {
                    const querySnapshot = await getDocs(collection(db, collInfo.name));
                    this.documents = [];
                    const allFields = new Set();

                    // Check if collection actually has any documents
                    if (querySnapshot.empty) {
                        // Collection is empty - remove from tracker and go back
                        await this.removeCollectionFromTracker();
                        this.showStatus('Collection was empty and has been removed.', 'info');
                        this.backToCollections();
                        await this.loadCollections();
                        return;
                    }

                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        this.documents.push({
                            id: docSnap.id,
                            data: data,
                            isPlaceholder: data._placeholder === true
                        });
                        Object.keys(data).forEach(key => allFields.add(key));
                    });

                    this.availableFields = Array.from(allFields).sort();
                    this.filteredDocuments = [...this.documents];

                    // Apply saved sorting if any
                    if (this.currentSortField && this.currentSortOrder) {
                        this.sortDocuments();
                    }

                    this.renderCollection();
                } catch (error) {
                    this.showStatus('Error loading documents: ' + error.message, 'error');
                    this.backToCollections();
                }
            }

            renderCollection() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('collection-view').style.display = 'block';

                const placeholderCount = this.documents.filter(d => d.isPlaceholder).length;
                const realDocCount = this.documents.length - placeholderCount;

                document.getElementById('collection-title').textContent = this.currentCollection.name;
                document.getElementById('document-count').innerHTML = `
                    ${realDocCount} documents
                    ${placeholderCount > 0 ? `<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${placeholderCount} placeholder${placeholderCount !== 1 ? 's' : ''}</span>` : ''}
                `;

                // Reset batch selection when rendering collection
                this.selectedDocuments.clear();
                this.showBatchActions = false;

                this.renderSearchOptions();
                this.renderTable();
                this.renderBatchActions();
            }

            showCollectionSettings() {
                this.templateFields = this.collectionTemplate ? [...this.collectionTemplate] : [];
                this.renderTemplateFields();
                document.getElementById('collection-settings-modal').style.display = 'flex';
            }

            hideCollectionSettings() {
                document.getElementById('collection-settings-modal').style.display = 'none';
            }

            renderTemplateFields() {
                const container = document.getElementById('template-fields-list');

                if (this.templateFields.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No fields defined yet. Add fields below.</p>';
                    return;
                }

                container.innerHTML = this.templateFields.map((field, index) => `
                    <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-lg border draggable-field"
                         draggable="true"
                         ondragstart="window.cmsApp.handleDragStart(${index})"
                         ondragover="window.cmsApp.handleDragOver(event)"
                         ondrop="window.cmsApp.handleDrop(${index})"
                         ondragend="window.cmsApp.handleDragEnd()">
                        <i class="fas fa-grip-vertical text-gray-400 mt-2"></i>
                        <div class="flex-1">
                            <div class="grid grid-cols-3 gap-4 mb-3">
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Field Name</label>
                                    <input type="text" value="${field.name}" 
                                           onchange="window.cmsApp.updateTemplateField(${index}, 'name', this.value)"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Display Name</label>
                                    <input type="text" value="${field.displayName}" 
                                           onchange="window.cmsApp.updateTemplateField(${index}, 'displayName', this.value)"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Type</label>
                                    <select onchange="window.cmsApp.updateTemplateFieldType(${index}, this.value)"
                                            class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="string" ${field.type === 'string' ? 'selected' : ''}>String</option>
                                        <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                                        <option value="boolean" ${field.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                                        <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                                        <option value="map" ${field.type === 'map' ? 'selected' : ''}>Map</option>
                                        <option value="array" ${field.type === 'array' ? 'selected' : ''}>Array</option>
                                        <option value="timestamp" ${field.type === 'timestamp' ? 'selected' : ''}>Timestamp</option>
                                        <option value="geopoint" ${field.type === 'geopoint' ? 'selected' : ''}>Geopoint</option>
                                        <option value="reference" ${field.type === 'reference' ? 'selected' : ''}>Reference</option>
                                    </select>
                                </div>
                            </div>
                            ${field.type === 'dropdown' ? `
                                <div>
                                    <label class="text-xs text-gray-500 block mb-2">Dropdown Options</label>
                                    <div class="space-y-2 mb-3">
                                        ${(field.options || []).map((option, optIndex) => `
                                            <div class="flex items-center space-x-2">
                                                <input type="text" value="${option}" 
                                                       onchange="window.cmsApp.updateDropdownOption(${index}, ${optIndex}, this.value)"
                                                       class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                       placeholder="Option value">
                                                <button type="button" onclick="window.cmsApp.removeDropdownOption(${index}, ${optIndex})"
                                                        class="text-red-600 hover:text-red-800 p-1" title="Remove option">
                                                    <i class="fas fa-trash text-xs"></i>
                                                </button>
                                            </div>
                                        `).join('')}
                                        ${(field.options || []).length === 0 ? `
                                            <div class="text-gray-500 text-sm py-2">No options defined yet</div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="new-option-${index}" placeholder="New option value"
                                               class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                               onkeypress="if(event.key === 'Enter') window.cmsApp.addDropdownOption(${index})">
                                        <button type="button" onclick="window.cmsApp.addDropdownOption(${index})"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                            <i class="fas fa-plus mr-1"></i>Add
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="window.cmsApp.removeTemplateField(${index})" 
                                class="text-red-600 hover:text-red-900 p-2 mt-2" title="Remove field">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            updateTemplateField(index, property, value) {
                if (index >= 0 && index < this.templateFields.length) {
                    this.templateFields[index][property] = typeof value === 'string' ? value.trim() : value;

                    // If changing type away from dropdown, remove options
                    if (property === 'type' && value !== 'dropdown' && this.templateFields[index].options) {
                        delete this.templateFields[index].options;
                    }

                    // If changing type to dropdown and no options exist, initialize empty array
                    if (property === 'type' && value === 'dropdown' && !this.templateFields[index].options) {
                        this.templateFields[index].options = [];
                    }
                }
            }

            handleDragStart(index) {
                this.draggedFieldIndex = index;
                event.target.style.opacity = '0.4';
            }

            handleDragOver(e) {
                e.preventDefault();
                return false;
            }

            handleDrop(dropIndex) {
                event.preventDefault();
                event.target.closest('.draggable-field').classList.remove('drag-over');

                if (this.draggedFieldIndex !== null && this.draggedFieldIndex !== dropIndex) {
                    const draggedField = this.templateFields[this.draggedFieldIndex];
                    this.templateFields.splice(this.draggedFieldIndex, 1);
                    this.templateFields.splice(dropIndex, 0, draggedField);
                    this.renderTemplateFields();
                }
            }

            handleDragEnd() {
                event.target.style.opacity = '1';
                this.draggedFieldIndex = null;
            }

            addTemplateField() {
                const name = document.getElementById('template-field-name').value.trim();
                const displayName = document.getElementById('template-field-display').value.trim();
                const type = document.getElementById('template-field-type').value;

                if (!name) { this.showStatus('Please enter a field name', 'error'); return; }
                if (!displayName) { this.showStatus('Please enter a display name', 'error'); return; }
                if (this.templateFields.find(f => f.name === name)) { this.showStatus('Field already exists in template', 'error'); return; }

                this.templateFields.push({ name, displayName, type });

                document.getElementById('template-field-name').value = '';
                document.getElementById('template-field-display').value = '';
                document.getElementById('template-field-type').value = 'string';

                this.renderTemplateFields();
                this.showStatus(`Field "${displayName}" added to template!`);
            }

            removeTemplateField(index) {
                if (confirm(`Remove "${this.templateFields[index].displayName}" from template?`)) {
                    this.templateFields.splice(index, 1);
                    this.renderTemplateFields();
                }
            }

            async saveCollectionSettings() {
                try {
                    // Ensure template fields with options are properly structured
                    const templateToSave = this.templateFields.map(field => {
                        const cleanField = {
                            name: field.name.trim(),
                            displayName: field.displayName.trim(),
                            type: field.type
                        };

                        // Only include options if it's a dropdown with actual options
                        if (field.type === 'dropdown' && field.options && Array.isArray(field.options) && field.options.length > 0) {
                            cleanField.options = field.options.filter(opt => opt && opt.trim()).map(opt => opt.trim());
                        }

                        return cleanField;
                    });

                    await updateDoc(doc(db, CMS_CONFIG.trackerCollection, this.currentCollection.id), {
                        template: templateToSave
                    });

                    this.collectionTemplate = templateToSave;
                    this.currentCollection.template = this.collectionTemplate;

                    this.hideCollectionSettings();
                    this.showStatus('Collection template saved successfully!');
                    await this.loadCollections();
                    this.renderTable();
                } catch (error) {
                    this.showStatus('Error saving template: ' + error.message, 'error');
                }
            }

            renderSearchOptions() {
                const searchSelect = document.getElementById('search-field');
                searchSelect.innerHTML = '<option value="">Search all fields</option>' +
                    this.availableFields.map(field => `<option value="${field}">${field}</option>`).join('');
            }

            getSortIcon(fieldName) {
                if (this.currentSortField !== fieldName) return '<i class="fas fa-sort text-gray-400 ml-2"></i>';
                return this.currentSortOrder === 'asc'
                    ? '<i class="fas fa-sort-up text-blue-600 ml-2"></i>'
                    : '<i class="fas fa-sort-down text-blue-600 ml-2"></i>';
            }

            getTableDisplayFields() {
                if (this.collectionTemplate && this.collectionTemplate.length > 0) {
                    const templateFieldNames = this.collectionTemplate.map(f => f.name);
                    const existingTemplateFields = templateFieldNames.filter(name => this.availableFields.includes(name));
                    if (existingTemplateFields.length < 4) {
                        const remainingFields = this.availableFields
                            .filter(f => !templateFieldNames.includes(f))
                            .slice(0, 4 - existingTemplateFields.length);
                        return [...existingTemplateFields, ...remainingFields];
                    }
                    return existingTemplateFields.slice(0, 4);
                }
                return this.availableFields.slice(0, 4);
            }

            renderTable() {
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');

                const displayFields = this.getTableDisplayFields();

                tableHead.innerHTML = `
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" 
                                   ${this.isAllSelected() ? 'checked' : ''} 
                                   ${this.isIndeterminate() ? 'indeterminate' : ''}
                                   onchange="window.cmsApp.toggleSelectAll(this.checked)"
                                   class="rounded text-blue-600 focus:ring-blue-500">
                        </th>
                        ${displayFields.map(header => `
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" 
                                onclick="window.cmsApp.toggleSort('${header}')">
                                <div class="flex items-center">
                                    ${this.getDisplayName(header)}
                                    ${this.getSortIcon(header)}
                                </div>
                            </th>
                        `).join('')}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                `;

                const isLastDocument = this.filteredDocuments.length === 1;

                tableBody.innerHTML = this.filteredDocuments.map(doc => `
                    <tr class="hover:bg-gray-50 ${doc.isPlaceholder ? 'bg-yellow-50 border-l-4 border-yellow-400' : ''} ${this.selectedDocuments.has(doc.id) ? 'bg-blue-50' : ''}">
                        <td class="px-6 py-4">
                            <input type="checkbox" 
                                   ${this.selectedDocuments.has(doc.id) ? 'checked' : ''}
                                   onchange="window.cmsApp.toggleDocumentSelection('${doc.id}', this.checked)"
                                   class="rounded text-blue-600 focus:ring-blue-500">
                        </td>
                        ${displayFields.map(field => `
                            <td class="px-6 py-4 text-sm text-gray-900 table-cell-max">
                                ${doc.isPlaceholder && field === displayFields[0] ?
                        '<span class="text-yellow-700 font-medium"><i class="fas fa-flag mr-1"></i>Placeholder Document</span>' :
                        this.formatFieldValue(doc.data[field])}
                            </td>
                        `).join('')}
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                ${!doc.isPlaceholder ? `
                                    <button onclick="window.cmsApp.editDocument('${doc.id}')" 
                                            class="text-blue-600 hover:text-blue-900" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.cmsApp.duplicateDocument('${doc.id}')" 
                                            class="text-green-600 hover:text-green-900" title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                ` : `
                                    <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">System</span>
                                `}
                                <button onclick="window.cmsApp.deleteDocumentWithWarning('${doc.id}', ${isLastDocument})" 
                                        class="text-red-600 hover:text-red-900" 
                                        title="${isLastDocument ? 'Delete (will remove collection)' : 'Delete'}">
                                    <i class="fas fa-trash"></i>
                                    ${isLastDocument ? '<i class="fas fa-exclamation-triangle ml-1"></i>' : ''}
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Set indeterminate state for "select all" checkbox after rendering
                const selectAllCheckbox = tableHead.querySelector('input[type="checkbox"]');
                if (selectAllCheckbox && this.isIndeterminate()) {
                    selectAllCheckbox.indeterminate = true;
                }

                this.renderBatchActions();
            }

            renderBatchActions() {
                const batchActionsContainer = document.getElementById('batch-actions-container');

                if (this.selectedDocuments.size > 0) {
                    const selectedCount = this.selectedDocuments.size;
                    const selectedDocs = Array.from(this.selectedDocuments);
                    const hasPlaceholders = selectedDocs.some(docId => {
                        const doc = this.documents.find(d => d.id === docId);
                        return doc && doc.isPlaceholder;
                    });

                    batchActionsContainer.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-check-square text-blue-600 mr-2"></i>
                                    <span class="text-blue-900 font-medium">
                                        ${selectedCount} document${selectedCount !== 1 ? 's' : ''} selected
                                    </span>
                                    ${hasPlaceholders ? `
                                        <span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                            Contains placeholder${selectedDocs.filter(docId => {
                        const doc = this.documents.find(d => d.id === docId);
                        return doc && doc.isPlaceholder;
                    }).length > 1 ? 's' : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button onclick="window.cmsApp.clearSelection()"
                                            class="text-gray-600 hover:text-gray-800 px-3 py-1 text-sm">
                                        Clear Selection
                                    </button>
                                    <button onclick="window.cmsApp.batchDeleteDocuments()"
                                            class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Delete Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    batchActionsContainer.style.display = 'block';
                } else {
                    batchActionsContainer.style.display = 'none';
                }
            }

            getDisplayName(fieldName) {
                if (!this.collectionTemplate) return fieldName;
                const templateField = this.collectionTemplate.find(f => f.name === fieldName);
                return templateField ? templateField.displayName : fieldName;
            }

            async toggleSort(fieldName) {
                if (this.currentSortField === fieldName) {
                    if (this.currentSortOrder === 'asc') {
                        this.currentSortOrder = 'desc';
                    } else {
                        // Clear sorting
                        this.currentSortField = null;
                        this.currentSortOrder = null;
                    }
                } else {
                    this.currentSortField = fieldName;
                    this.currentSortOrder = 'asc';
                }

                // Save sort state to collection tracker
                await this.saveSortState();

                this.sortDocuments();
                this.renderTable();
            }

            async saveSortState() {
                try {
                    const updateData = {
                        sortField: this.currentSortField,
                        sortOrder: this.currentSortOrder
                    };

                    await updateDoc(doc(db, CMS_CONFIG.trackerCollection, this.currentCollection.id), updateData);

                    // Update local collection object
                    this.currentCollection.sortField = this.currentSortField;
                    this.currentCollection.sortOrder = this.currentSortOrder;

                    // Also update in collections array
                    const collIndex = this.collections.findIndex(c => c.id === this.currentCollection.id);
                    if (collIndex !== -1) {
                        this.collections[collIndex].sortField = this.currentSortField;
                        this.collections[collIndex].sortOrder = this.currentSortOrder;
                    }

                } catch (error) {
                    console.error('Error saving sort state:', error);
                    // Don't show error to user as it's not critical
                }
            }

            sortDocuments() {
                if (!this.currentSortField || !this.currentSortOrder) {
                    this.filteredDocuments = this.documents.filter(doc => {
                        const searchTerm = document.getElementById('search-input').value.toLowerCase();
                        const searchField = document.getElementById('search-field').value;

                        if (!searchTerm) return true;

                        if (searchField) {
                            const fieldValue = doc.data[searchField];
                            return fieldValue && String(fieldValue).toLowerCase().includes(searchTerm);
                        } else {
                            return Object.values(doc.data).some(value =>
                                String(value).toLowerCase().includes(searchTerm)
                            ) || doc.id.toLowerCase().includes(searchTerm);
                        }
                    });
                    return;
                }

                this.filteredDocuments.sort((a, b) => {
                    const aVal = a.data[this.currentSortField];
                    const bVal = b.data[this.currentSortField];

                    if (aVal === bVal) return 0;
                    if (aVal === undefined || aVal === null) return 1;
                    if (bVal === undefined || bVal === null) return -1;

                    const result = aVal < bVal ? -1 : 1;
                    return this.currentSortOrder === 'asc' ? result : -result;
                });
            }

            formatFieldValue(value) {
                if (value === null || value === undefined) return '<span class="text-gray-400">null</span>';
                if (typeof value === 'boolean') return `<span class="text-${value ? 'green' : 'red'}-600">${value}</span>`;
                if (value instanceof Date || (value && value.toDate)) {
                    const date = value instanceof Date ? value : value.toDate();
                    return `<span class="text-purple-600">${date.toLocaleDateString()}</span>`;
                }
                if (typeof value === 'object') {
                    if (value.latitude && value.longitude) return `<span class="text-blue-600">GeoPoint</span>`;
                    return `<span class="text-orange-600">{Object}</span>`;
                }
                if (Array.isArray(value)) return `<span class="text-indigo-600">[Array(${value.length})]</span>`;

                const str = String(value);
                return str.length > 30 ? str.substring(0, 30) + '...' : str;
            }

            editDocument(docId) {
                const doc = this.documents.find(d => d.id === docId);
                this.currentDocument = doc;
                this.isNewDocument = false;
                this.documentForm = { ...doc.data };

                this.fieldTypes = {};
                Object.keys(doc.data).forEach(key => {
                    // Check if this field is defined in template first
                    const templateField = this.collectionTemplate?.find(f => f.name === key);
                    if (templateField) {
                        // Use template type instead of detecting from value
                        this.fieldTypes[key] = templateField.type;
                    } else {
                        // Fall back to detecting type from value for fields not in template
                        this.fieldTypes[key] = this.detectFirebaseType(doc.data[key]);
                    }
                });

                this.originalDocumentFields = new Set(Object.keys(doc.data));
                this.fieldsToDelete = new Set();
                this.renderDocumentEditor();
            }

            createNewDocument() {
                this.currentDocument = null;
                this.isNewDocument = true;
                this.documentForm = {};
                this.fieldTypes = {};

                if (this.collectionTemplate && this.collectionTemplate.length > 0) {
                    this.collectionTemplate.forEach(field => {
                        this.documentForm[field.name] = this.getDefaultValueForType(field.type);
                        this.fieldTypes[field.name] = field.type;
                    });
                }

                this.originalDocumentFields = new Set();
                this.fieldsToDelete = new Set();
                this.renderDocumentEditor();
            }

            getDefaultValueForType(type) {
                switch (type) {
                    case 'string': return '';
                    case 'number': return 0;
                    case 'boolean': return false;
                    case 'dropdown': return '';
                    case 'map': return {};
                    case 'array': return [];
                    case 'timestamp': return new Date();
                    case 'geopoint': return { latitude: 0, longitude: 0 };
                    case 'reference': return { path: '' };
                    default: return '';
                }
            }

            renderDocumentEditor() {
                document.getElementById('collection-view').style.display = 'none';
                document.getElementById('document-editor').style.display = 'block';

                const editorTitle = document.getElementById('editor-title');
                if (this.isNewDocument) {
                    editorTitle.innerHTML = 'New Document';
                } else {
                    editorTitle.innerHTML = `
                        Edit Document
                        <div class="flex items-center mt-2 space-x-2">
                            <span class="text-sm text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded">
                                ID: ${this.currentDocument.id}
                            </span>
                            <button onclick="window.cmsApp.copyDocumentId()" 
                                    class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors"
                                    title="Copy document ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    `;
                }

                const form = document.getElementById('document-form');

                let sortedFields;
                if (this.collectionTemplate && this.collectionTemplate.length > 0) {
                    const templateFieldNames = this.collectionTemplate.map(f => f.name);
                    const extraFields = Object.keys(this.documentForm).filter(k => !templateFieldNames.includes(k)).sort();
                    sortedFields = [...templateFieldNames.filter(name => this.documentForm.hasOwnProperty(name)), ...extraFields];
                } else {
                    sortedFields = Object.keys(this.documentForm).sort();
                }

                if (sortedFields.length === 0) {
                    form.innerHTML = '<p class="text-gray-500 text-center py-8">No fields yet. Add fields using the section below.</p>';
                } else {
                    form.innerHTML = sortedFields.map(key => {
                        const value = this.documentForm[key];
                        const fieldType = this.fieldTypes[key] || this.detectFirebaseType(value);
                        const displayName = this.getDisplayName(key);

                        // Check if this field is defined in template (type enforcement)
                        const templateField = this.collectionTemplate?.find(f => f.name === key);
                        const isTemplateField = !!templateField;

                        return `
                            <div class="flex items-center space-x-4">
                                <div class="w-32">
                                    <label class="block text-sm font-medium text-gray-700">${displayName}</label>
                                    ${displayName !== key ? `<span class="text-xs text-gray-400">(${key})</span>` : ''}
                                    ${isTemplateField ? `<span class="text-xs text-blue-500" title="Template field - type locked"><i class="fas fa-lock"></i></span>` : ''}
                                </div>
                                <div class="w-20">
                                    <select onchange="window.cmsApp.changeFieldType('${key}', this.value)"
                                            class="text-xs text-gray-600 border border-gray-200 rounded px-1 py-1 bg-gray-50"
                                            ${isTemplateField ? 'disabled title="Type locked by template"' : ''}>
                                        <option value="string" ${fieldType === 'string' ? 'selected' : ''}>string</option>
                                        <option value="number" ${fieldType === 'number' ? 'selected' : ''}>number</option>
                                        <option value="boolean" ${fieldType === 'boolean' ? 'selected' : ''}>boolean</option>
                                        <option value="dropdown" ${fieldType === 'dropdown' ? 'selected' : ''}>dropdown</option>
                                        <option value="map" ${fieldType === 'map' ? 'selected' : ''}>map</option>
                                        <option value="array" ${fieldType === 'array' ? 'selected' : ''}>array</option>
                                        <option value="null" ${fieldType === 'null' ? 'selected' : ''}>null</option>
                                        <option value="timestamp" ${fieldType === 'timestamp' ? 'selected' : ''}>timestamp</option>
                                        <option value="geopoint" ${fieldType === 'geopoint' ? 'selected' : ''}>geopoint</option>
                                        <option value="reference" ${fieldType === 'reference' ? 'selected' : ''}>reference</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    ${this.renderFormField(key, value, fieldType)}
                                </div>
                                <button onclick="window.cmsApp.removeField('${key}')" 
                                        class="text-red-600 hover:text-red-900 p-2" title="Remove field">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('new-field-name').value = '';
                document.getElementById('new-field-type').value = 'string';
            }

            copyDocumentId() {
                if (this.currentDocument && this.currentDocument.id) {
                    navigator.clipboard.writeText(this.currentDocument.id).then(() => {
                        this.showStatus('Document ID copied to clipboard!', 'success');
                    }).catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = this.currentDocument.id;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showStatus('Document ID copied to clipboard!', 'success');
                    });
                }
            }

            detectFirebaseType(value) {
                if (value === null || value === undefined) return 'null';
                if (typeof value === 'boolean') return 'boolean';
                if (typeof value === 'number') return 'number';
                if (typeof value === 'string') return 'string';
                if (Array.isArray(value)) return 'array';
                if (value instanceof Date || (value && value.toDate)) return 'timestamp';
                if (value && value.latitude !== undefined && value.longitude !== undefined) return 'geopoint';
                if (value && value.path) return 'reference';
                if (typeof value === 'object') return 'map';
                return 'string';
            }

            changeFieldType(key, newType) {
                // Check if this field is defined in template
                const templateField = this.collectionTemplate?.find(f => f.name === key);
                if (templateField) {
                    this.showStatus(`Field "${key}" type is locked by template configuration`, 'error');
                    this.renderDocumentEditor(); // Reset the dropdown
                    return;
                }

                this.fieldTypes[key] = newType;

                let newValue;
                switch (newType) {
                    case 'string': newValue = this.documentForm[key] ? String(this.documentForm[key]) : ''; break;
                    case 'number': newValue = parseFloat(this.documentForm[key]) || 0; break;
                    case 'boolean': newValue = Boolean(this.documentForm[key]); break;
                    case 'dropdown': newValue = ''; break;
                    case 'map': newValue = {}; break;
                    case 'array': newValue = []; break;
                    case 'null': newValue = null; break;
                    case 'timestamp': newValue = new Date(); break;
                    case 'geopoint': newValue = { latitude: 0, longitude: 0 }; break;
                    case 'reference': newValue = { path: '' }; break;
                    default: newValue = '';
                }

                this.documentForm[key] = newValue;
                this.renderDocumentEditor();
            }

            renderFormField(key, value, fieldType) {
                // Check if this field has template configuration for dropdown AND the current fieldType is dropdown
                const templateField = this.collectionTemplate?.find(f => f.name === key);
                const isDropdownWithOptions = fieldType === 'dropdown' && templateField?.type === 'dropdown' && templateField.options && templateField.options.length > 0;

                if (isDropdownWithOptions) {
                    const options = templateField.options;
                    const selectedValue = value || '';

                    return `
                        <select id="field-${key}" onchange="window.cmsApp.updateField('${key}', this.value)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select ${templateField.displayName || key} --</option>
                            ${options.map(option => `
                                <option value="${option}" ${selectedValue === option ? 'selected' : ''}>${option}</option>
                            `).join('')}
                        </select>
                    `;
                }

                // Handle dropdown type without template options
                if (fieldType === 'dropdown' && !isDropdownWithOptions) {
                    return `
                        <div class="text-orange-600 bg-orange-50 px-3 py-2 rounded border border-orange-200">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Dropdown field but no options defined in template. 
                            <button onclick="window.cmsApp.changeFieldType('${key}', 'string')" 
                                    class="ml-2 text-blue-600 underline text-sm">
                                Change to string
                            </button>
                        </div>
                    `;
                }

                // Regular field rendering for non-dropdown fields
                switch (fieldType) {
                    case 'boolean':
                        return `<input type="checkbox" id="field-${key}" ${value ? 'checked' : ''} onchange="window.cmsApp.updateField('${key}', this.checked)" class="rounded text-blue-600 focus:ring-blue-500">`;
                    case 'number':
                        return `<input type="number" id="field-${key}" value="${value !== null && value !== undefined ? value : ''}" onchange="window.cmsApp.updateField('${key}', this.value === '' ? null : parseFloat(this.value))" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                    case 'timestamp':
                        const dateValue = value instanceof Date ? value.toISOString().slice(0, 16) : (value && value.toDate) ? value.toDate().toISOString().slice(0, 16) : '';
                        return `<input type="datetime-local" id="field-${key}" value="${dateValue}" onchange="window.cmsApp.updateField('${key}', this.value === '' ? null : new Date(this.value))" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                    case 'geopoint':
                        const lat = value?.latitude || 0;
                        const lng = value?.longitude || 0;
                        return `<div class="grid grid-cols-2 gap-2"><input type="number" step="any" placeholder="Latitude" value="${lat}" onchange="window.cmsApp.updateGeopoint('${key}', 'latitude', parseFloat(this.value) || 0)" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><input type="number" step="any" placeholder="Longitude" value="${lng}" onchange="window.cmsApp.updateGeopoint('${key}', 'longitude', parseFloat(this.value) || 0)" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>`;
                    case 'array':
                        return this.renderArrayEditor(key, value);
                    case 'map':
                        const mapValue = value !== null ? JSON.stringify(value, null, 2) : '';
                        return `<textarea id="field-${key}" rows="4" placeholder="Enter JSON object or leave empty for null" onchange="window.cmsApp.updateFieldFromJSON('${key}', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm">${mapValue}</textarea>`;
                    case 'reference':
                        return `<input type="text" id="field-${key}" value="${value?.path || ''}" placeholder="collection/document or leave empty for null" onchange="window.cmsApp.updateField('${key}', this.value === '' ? null : {path: this.value})" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                    case 'null':
                        return `<span class="text-gray-500 py-2">null</span>`;
                    default:
                        return `<input type="text" id="field-${key}" value="${value !== null && value !== undefined ? value : ''}" onchange="window.cmsApp.updateField('${key}', this.value === '' ? null : this.value)" placeholder="Leave empty for null" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                }
            }

            renderArrayEditor(key, value) {
                const arrayValue = Array.isArray(value) ? value : [];
                const arrayId = `array-${key}`;

                return `
                    <div class="space-y-3 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Array Items</span>
                            <div class="flex items-center space-x-2">
                                <button type="button" onclick="window.cmsApp.addArrayItem('${key}')" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-plus mr-1"></i>Add Item
                                </button>
                                <button type="button" onclick="window.cmsApp.toggleArrayMode('${key}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-code mr-1"></i>JSON Mode
                                </button>
                            </div>
                        </div>
                        <div id="${arrayId}-items" class="space-y-2">
                            ${arrayValue.map((item, index) => this.renderArrayItem(key, item, index)).join('')}
                        </div>
                        ${arrayValue.length === 0 ? `
                            <div class="text-center py-4 text-gray-500 text-sm">
                                No items yet. Click "Add Item" to get started.
                            </div>
                        ` : ''}
                        <div id="${arrayId}-json" style="display: none;">
                            <textarea rows="6" placeholder="Enter JSON array" 
                                      onchange="window.cmsApp.updateArrayFromJSON('${key}', this.value)"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm">${JSON.stringify(arrayValue, null, 2)}</textarea>
                        </div>
                    </div>
                `;
            }

            renderArrayItem(fieldKey, item, index) {
                const itemType = this.detectArrayItemType(item);
                const itemId = `${fieldKey}-item-${index}`;

                return `
                    <div class="flex items-center space-x-2 bg-white p-3 rounded border">
                        <div class="flex-shrink-0 w-8 text-sm text-gray-500 text-center">${index + 1}</div>
                        <div class="flex-shrink-0">
                            <select onchange="window.cmsApp.changeArrayItemType('${fieldKey}', ${index}, this.value)"
                                    class="text-xs text-gray-600 border border-gray-200 rounded px-1 py-1 bg-gray-50">
                                <option value="string" ${itemType === 'string' ? 'selected' : ''}>string</option>
                                <option value="number" ${itemType === 'number' ? 'selected' : ''}>number</option>
                                <option value="boolean" ${itemType === 'boolean' ? 'selected' : ''}>boolean</option>
                                <option value="object" ${itemType === 'object' ? 'selected' : ''}>object</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            ${this.renderArrayItemInput(fieldKey, item, index, itemType)}
                        </div>
                        <div class="flex-shrink-0 flex space-x-1">
                            <button type="button" onclick="window.cmsApp.moveArrayItem('${fieldKey}', ${index}, -1)" 
                                    ${index === 0 ? 'disabled' : ''}
                                    class="text-gray-400 hover:text-gray-600 disabled:opacity-30 p-1" title="Move up">
                                <i class="fas fa-chevron-up text-xs"></i>
                            </button>
                            <button type="button" onclick="window.cmsApp.moveArrayItem('${fieldKey}', ${index}, 1)" 
                                    class="text-gray-400 hover:text-gray-600 p-1" title="Move down">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <button type="button" onclick="window.cmsApp.removeArrayItem('${fieldKey}', ${index})" 
                                    class="text-red-500 hover:text-red-700 p-1" title="Remove">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            renderArrayItemInput(fieldKey, item, index, itemType) {
                switch (itemType) {
                    case 'boolean':
                        return `<input type="checkbox" ${item ? 'checked' : ''} 
                                       onchange="window.cmsApp.updateArrayItem('${fieldKey}', ${index}, this.checked)" 
                                       class="rounded text-blue-600 focus:ring-blue-500">`;
                    case 'number':
                        return `<input type="number" step="any" value="${item || ''}" 
                                       onchange="window.cmsApp.updateArrayItem('${fieldKey}', ${index}, parseFloat(this.value) || 0)" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">`;
                    case 'object':
                        return `<textarea rows="2" 
                                          onchange="window.cmsApp.updateArrayItemFromJSON('${fieldKey}', ${index}, this.value)"
                                          placeholder="Enter JSON object"
                                          class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 font-mono text-sm">${JSON.stringify(item, null, 2)}</textarea>`;
                    default: // string
                        return `<input type="text" value="${item || ''}" 
                                       onchange="window.cmsApp.updateArrayItem('${fieldKey}', ${index}, this.value)" 
                                       placeholder="Enter text..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">`;
                }
            }

            detectArrayItemType(item) {
                if (typeof item === 'boolean') return 'boolean';
                if (typeof item === 'number') return 'number';
                if (typeof item === 'object' && item !== null) return 'object';
                return 'string';
            }

            addArrayItem(fieldKey) {
                if (!Array.isArray(this.documentForm[fieldKey])) {
                    this.documentForm[fieldKey] = [];
                }
                this.documentForm[fieldKey].push('');
                this.renderDocumentEditor();
            }

            removeArrayItem(fieldKey, index) {
                if (Array.isArray(this.documentForm[fieldKey])) {
                    this.documentForm[fieldKey].splice(index, 1);
                    this.renderDocumentEditor();
                }
            }

            moveArrayItem(fieldKey, index, direction) {
                const array = this.documentForm[fieldKey];
                if (!Array.isArray(array)) return;

                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= array.length) return;

                const item = array.splice(index, 1)[0];
                array.splice(newIndex, 0, item);
                this.renderDocumentEditor();
            }

            updateArrayItem(fieldKey, index, value) {
                if (!Array.isArray(this.documentForm[fieldKey])) {
                    this.documentForm[fieldKey] = [];
                }
                this.documentForm[fieldKey][index] = value;
            }

            updateArrayItemFromJSON(fieldKey, index, jsonString) {
                try {
                    const parsedValue = JSON.parse(jsonString);
                    this.updateArrayItem(fieldKey, index, parsedValue);
                } catch (error) {
                    this.showStatus('Invalid JSON format', 'error');
                }
            }

            changeArrayItemType(fieldKey, index, newType) {
                const currentValue = this.documentForm[fieldKey][index];
                let convertedValue;

                switch (newType) {
                    case 'boolean':
                        convertedValue = Boolean(currentValue);
                        break;
                    case 'number':
                        convertedValue = parseFloat(currentValue) || 0;
                        break;
                    case 'object':
                        convertedValue = typeof currentValue === 'object' ? currentValue : {};
                        break;
                    default: // string
                        convertedValue = String(currentValue || '');
                }

                this.updateArrayItem(fieldKey, index, convertedValue);
                this.renderDocumentEditor();
            }

            updateArrayFromJSON(fieldKey, jsonString) {
                try {
                    if (jsonString.trim() === '') {
                        this.documentForm[fieldKey] = [];
                    } else {
                        const parsedArray = JSON.parse(jsonString);
                        if (Array.isArray(parsedArray)) {
                            this.documentForm[fieldKey] = parsedArray;
                        } else {
                            this.showStatus('Value must be an array', 'error');
                            return;
                        }
                    }
                    this.renderDocumentEditor();
                } catch (error) {
                    this.showStatus('Invalid JSON format', 'error');
                }
            }

            toggleArrayMode(fieldKey) {
                const itemsDiv = document.getElementById(`array-${fieldKey}-items`);
                const jsonDiv = document.getElementById(`array-${fieldKey}-json`);

                if (itemsDiv.style.display === 'none') {
                    // Switch to item mode
                    itemsDiv.style.display = 'block';
                    jsonDiv.style.display = 'none';
                } else {
                    // Switch to JSON mode
                    itemsDiv.style.display = 'none';
                    jsonDiv.style.display = 'block';
                    // Update the textarea with current array value
                    const textarea = jsonDiv.querySelector('textarea');
                    textarea.value = JSON.stringify(this.documentForm[fieldKey] || [], null, 2);
                }
            }

            updateField(key, value) {
                this.documentForm[key] = value;
            }

            updateFieldFromJSON(key, jsonString) {
                try {
                    if (jsonString.trim() === '') {
                        this.documentForm[key] = null;
                    } else {
                        this.documentForm[key] = JSON.parse(jsonString);
                    }
                } catch (error) {
                    this.showStatus('Invalid JSON format', 'error');
                }
            }

            updateGeopoint(key, coord, value) {
                if (!this.documentForm[key]) {
                    this.documentForm[key] = { latitude: 0, longitude: 0 };
                }
                this.documentForm[key][coord] = value;
            }

            removeField(key) {
                if (confirm(`Are you sure you want to remove the field "${key}"?`)) {
                    delete this.documentForm[key];
                    delete this.fieldTypes[key];

                    if (this.originalDocumentFields.has(key)) {
                        this.fieldsToDelete.add(key);
                    }

                    this.renderDocumentEditor();
                }
            }

            addNewFieldWithType() {
                const fieldName = document.getElementById('new-field-name').value.trim();
                const fieldType = document.getElementById('new-field-type').value;

                if (!fieldName) { this.showStatus('Please enter a field name', 'error'); return; }
                if (this.documentForm.hasOwnProperty(fieldName)) { this.showStatus('Field already exists', 'error'); return; }

                // Check if this field name matches a template field
                const templateField = this.collectionTemplate?.find(f => f.name === fieldName);
                if (templateField) {
                    // Use template type and value instead
                    this.documentForm[fieldName] = this.getDefaultValueForType(templateField.type);
                    this.fieldTypes[fieldName] = templateField.type;
                    this.showStatus(`Field "${fieldName}" added using template configuration (${templateField.type})`, 'info');
                } else {
                    // Create field with selected type
                    this.documentForm[fieldName] = this.getDefaultValueForType(fieldType);
                    this.fieldTypes[fieldName] = fieldType;
                    this.showStatus(`Field "${fieldName}" added successfully!`);
                }

                this.fieldsToDelete.delete(fieldName);
                this.renderDocumentEditor();
            }

            async saveDocument() {
                try {
                    const cleanData = {};

                    Object.entries(this.documentForm).forEach(([key, value]) => {
                        if (Array.isArray(value)) {
                            // Filter out empty strings and null values from arrays
                            const filteredArray = value.filter(item =>
                                item !== '' && item !== null && item !== undefined
                            );
                            cleanData[key] = filteredArray;
                        } else if (value instanceof Date) {
                            cleanData[key] = Timestamp.fromDate(value);
                        } else if (value && typeof value === 'object' && value.latitude !== undefined) {
                            cleanData[key] = new GeoPoint(value.latitude, value.longitude);
                        } else {
                            cleanData[key] = value;
                        }
                    });

                    this.fieldsToDelete.forEach(fieldName => {
                        cleanData[fieldName] = deleteField();
                    });

                    if (this.isNewDocument) {
                        const newDocData = {};
                        Object.entries(cleanData).forEach(([key, value]) => {
                            if (value !== deleteField()) newDocData[key] = value;
                        });

                        await addDoc(collection(db, this.currentCollection.name), newDocData);
                        this.showStatus('Document created successfully!');
                    } else {
                        const docRef = doc(db, this.currentCollection.name, this.currentDocument.id);
                        await updateDoc(docRef, cleanData);
                        this.showStatus('Document updated successfully!');
                    }

                    // Update collection's lastModified timestamp
                    await this.updateCollectionLastModified();

                    this.backToCollection();
                    await this.selectCollection(this.currentCollection.id);
                } catch (error) {
                    this.showStatus('Error saving document: ' + error.message, 'error');
                }
            }

            async deleteDocument(docId) {
                if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) return;

                try {
                    const docRef = doc(db, this.currentCollection.name, docId);
                    await deleteDoc(docRef);

                    // Update collection's lastModified timestamp
                    await this.updateCollectionLastModified();

                    // Check if this was the last document in the collection
                    const remainingDocs = this.documents.filter(d => d.id !== docId);

                    if (remainingDocs.length === 0) {
                        // This was the last document - collection will be auto-deleted by Firestore
                        // Remove the collection from our tracker
                        await this.removeCollectionFromTracker();
                        this.showStatus('Document deleted. Collection was empty and has been removed.', 'success');
                        // Go back to collections view since this collection no longer exists
                        this.backToCollections();
                        await this.loadCollections();
                    } else {
                        this.showStatus('Document deleted successfully!');
                        await this.selectCollection(this.currentCollection.id);
                    }
                } catch (error) {
                    this.showStatus('Error deleting document: ' + error.message, 'error');
                }
            }

            async removeCollectionFromTracker() {
                try {
                    const trackerDocRef = doc(db, CMS_CONFIG.trackerCollection, this.currentCollection.id);
                    await deleteDoc(trackerDocRef);
                } catch (error) {
                    console.error('Error removing collection from tracker:', error);
                    // Don't show error to user as the main operation (document deletion) succeeded
                }
            }

            async deleteDocumentWithWarning(docId, isLastDocument) {
                let confirmMessage = 'Are you sure you want to delete this document? This action cannot be undone.';

                if (isLastDocument) {
                    confirmMessage = `This is the last document in the collection. Deleting it will also remove the entire "${this.currentCollection.name}" collection from the CMS.\n\nAre you sure you want to proceed?`;
                }

                if (!confirm(confirmMessage)) return;

                await this.deleteDocument(docId);
            }

            duplicateDocument(docId) {
                const document = this.documents.find(d => d.id === docId);
                this.currentDocument = null;
                this.isNewDocument = true;
                this.documentForm = { ...document.data };

                this.fieldTypes = {};
                Object.keys(document.data).forEach(key => {
                    this.fieldTypes[key] = this.detectFirebaseType(document.data[key]);
                });

                this.originalDocumentFields = new Set();
                this.fieldsToDelete = new Set();
                this.renderDocumentEditor();
            }

            filterDocuments() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const searchField = document.getElementById('search-field').value;

                if (!searchTerm) {
                    this.filteredDocuments = [...this.documents];
                } else if (searchField) {
                    this.filteredDocuments = this.documents.filter(doc => {
                        const fieldValue = doc.data[searchField];
                        return fieldValue && String(fieldValue).toLowerCase().includes(searchTerm);
                    });
                } else {
                    this.filteredDocuments = this.documents.filter(doc => {
                        return Object.values(doc.data).some(value =>
                            String(value).toLowerCase().includes(searchTerm)
                        ) || doc.id.toLowerCase().includes(searchTerm);
                    });
                }

                // Clear selection when filtering changes the visible documents
                this.selectedDocuments.clear();

                this.sortDocuments();
                this.renderTable();
            }

            backToCollections() {
                document.getElementById('collection-view').style.display = 'none';
                document.getElementById('document-editor').style.display = 'none';
                document.getElementById('collections-view').style.display = 'block';
                this.currentCollection = null;
            }

            backToCollection() {
                document.getElementById('document-editor').style.display = 'none';
                document.getElementById('collection-view').style.display = 'block';
            }

            async refreshView() {
                // Clear current state
                this.documents = [];
                this.filteredDocuments = [];
                this.availableFields = [];

                // Show loading state
                if (this.currentCollection) {
                    document.getElementById('collection-view').style.display = 'none';
                    document.getElementById('loading-state').style.display = 'block';

                    // Reload the current collection completely
                    await this.selectCollection(this.currentCollection.id);
                } else {
                    document.getElementById('collections-view').style.display = 'none';
                    document.getElementById('loading-state').style.display = 'block';

                    // Reload collections completely
                    await this.loadCollections();
                }
            }

            showStatus(message, type = 'success') {
                const statusDiv = document.getElementById('status-message');
                const statusIcon = document.getElementById('status-icon');
                const statusText = document.getElementById('status-text');

                statusIcon.className = type === 'success'
                    ? 'fas fa-check-circle text-green-500'
                    : type === 'info'
                        ? 'fas fa-info-circle text-blue-500'
                        : 'fas fa-exclamation-circle text-red-500';

                statusText.className = type === 'success'
                    ? 'text-sm text-green-800'
                    : type === 'info'
                        ? 'text-sm text-blue-800'
                        : 'text-sm text-red-800';

                statusText.textContent = message;

                const borderColor = type === 'success' ? 'border-green-500' : type === 'info' ? 'border-blue-500' : 'border-red-500';
                statusDiv.className = `fixed bottom-4 right-4 max-w-sm w-full bg-white border-l-4 p-4 shadow-lg rounded-lg z-50 ${borderColor}`;

                statusDiv.style.display = 'block';

                setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            }

            hideStatus() {
                document.getElementById('status-message').style.display = 'none';
            }

            addDropdownOption(fieldIndex) {
                const input = document.getElementById(`new-option-${fieldIndex}`);
                const newOption = input.value.trim();

                if (!newOption) {
                    this.showStatus('Please enter an option value', 'error');
                    return;
                }

                if (!this.templateFields[fieldIndex].options) {
                    this.templateFields[fieldIndex].options = [];
                }

                // Check for duplicates
                if (this.templateFields[fieldIndex].options.includes(newOption)) {
                    this.showStatus('Option already exists', 'error');
                    return;
                }

                this.templateFields[fieldIndex].options.push(newOption);
                input.value = '';
                this.renderTemplateFields();
                this.showStatus(`Option "${newOption}" added!`);
            }

            removeDropdownOption(fieldIndex, optionIndex) {
                if (this.templateFields[fieldIndex].options && optionIndex >= 0 && optionIndex < this.templateFields[fieldIndex].options.length) {
                    const removedOption = this.templateFields[fieldIndex].options[optionIndex];
                    this.templateFields[fieldIndex].options.splice(optionIndex, 1);
                    this.renderTemplateFields();
                    this.showStatus(`Option "${removedOption}" removed`);
                }
            }

            updateDropdownOption(fieldIndex, optionIndex, newValue) {
                const trimmedValue = newValue.trim();

                if (!trimmedValue) {
                    this.showStatus('Option value cannot be empty', 'error');
                    this.renderTemplateFields(); // Reset the input
                    return;
                }

                // Check for duplicates (excluding the current option)
                const currentOptions = this.templateFields[fieldIndex].options || [];
                const isDuplicate = currentOptions.some((opt, idx) => idx !== optionIndex && opt === trimmedValue);

                if (isDuplicate) {
                    this.showStatus('Option already exists', 'error');
                    this.renderTemplateFields(); // Reset the input
                    return;
                }

                if (this.templateFields[fieldIndex].options) {
                    this.templateFields[fieldIndex].options[optionIndex] = trimmedValue;
                }
            }

            updateTemplateFieldType(index, type) {
                this.templateFields[index].type = type;
                // Initialize options array for dropdown type
                if (type === 'dropdown' && !this.templateFields[index].options) {
                    this.templateFields[index].options = [];
                }
                // Remove options if changing away from dropdown
                if (type !== 'dropdown' && this.templateFields[index].options) {
                    delete this.templateFields[index].options;
                }
                this.renderTemplateFields();
            }

            showImportModal() {
                this.resetImportState();
                document.getElementById('csv-import-modal').style.display = 'flex';
            }

            hideImportModal() {
                document.getElementById('csv-import-modal').style.display = 'none';
                this.resetImportState();
            }

            resetImportState() {
                this.csvData = null;
                this.csvHeaders = [];
                this.csvRows = [];
                this.fieldMapping = {};
                this.importStep = 1;
                this.importProgress = {
                    total: 0,
                    current: 0,
                    success: 0,
                    errors: 0,
                    errorDetails: []
                };

                // Reset UI
                document.getElementById('import-step-1').style.display = 'block';
                document.getElementById('import-step-2').style.display = 'none';
                document.getElementById('import-step-3').style.display = 'none';
                document.getElementById('import-back-btn').style.display = 'none';
                document.getElementById('import-next-btn').style.display = 'inline-block';
                document.getElementById('import-start-btn').style.display = 'none';
                document.getElementById('import-finish-btn').style.display = 'none';
                document.getElementById('import-next-btn').disabled = true;
                document.getElementById('csv-file-info').classList.add('hidden');
                document.getElementById('csv-file-input').value = '';
            }

            handleCSVFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.showStatus('Please select a CSV file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        this.parseCSV(csvText);

                        // Show file info
                        document.getElementById('csv-file-name').textContent = file.name;
                        document.getElementById('csv-file-size').textContent = `(${this.formatFileSize(file.size)})`;
                        document.getElementById('csv-file-info').classList.remove('hidden');
                        document.getElementById('import-next-btn').disabled = false;

                        this.showStatus(`CSV file loaded: ${this.csvRows.length} rows found`, 'success');
                    } catch (error) {
                        this.showStatus('Error reading CSV file: ' + error.message, 'error');
                    }
                };

                reader.readAsText(file);
            }

            parseCSV(csvText) {
                // Simple CSV parser - handles basic CSV format
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('CSV file must have at least a header row and one data row');
                }

                // Parse headers
                this.csvHeaders = this.parseCSVLine(lines[0]);

                // Parse data rows
                this.csvRows = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = this.parseCSVLine(lines[i]);
                    if (row.length > 0 && row.some(cell => cell.trim())) { // Skip empty rows
                        this.csvRows.push(row);
                    }
                }
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }

                result.push(current.trim());
                return result;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            importNextStep() {
                if (this.importStep === 1) {
                    this.showMappingStep();
                }
            }

            importPreviousStep() {
                if (this.importStep === 2) {
                    this.importStep = 1;
                    document.getElementById('import-step-1').style.display = 'block';
                    document.getElementById('import-step-2').style.display = 'none';
                    document.getElementById('import-back-btn').style.display = 'none';
                    document.getElementById('import-next-btn').style.display = 'inline-block';
                    document.getElementById('import-start-btn').style.display = 'none';
                }
            }

            showMappingStep() {
                this.importStep = 2;
                document.getElementById('import-step-1').style.display = 'none';
                document.getElementById('import-step-2').style.display = 'block';
                document.getElementById('import-back-btn').style.display = 'inline-block';
                document.getElementById('import-next-btn').style.display = 'none';
                document.getElementById('import-start-btn').style.display = 'inline-block';

                this.renderCSVPreview();
                this.renderFieldMapping();
            }

            renderCSVPreview() {
                const previewContainer = document.getElementById('csv-preview-content');
                const previewRows = this.csvRows.slice(0, 3); // Show first 3 rows

                let html = '<table class="min-w-full text-sm">';

                // Headers
                html += '<thead class="bg-gray-100"><tr>';
                this.csvHeaders.forEach(header => {
                    html += `<th class="px-3 py-2 text-left font-medium text-gray-700 border">${header}</th>`;
                });
                html += '</tr></thead>';

                // Data rows
                html += '<tbody>';
                previewRows.forEach((row, rowIndex) => {
                    html += '<tr class="hover:bg-gray-50">';
                    this.csvHeaders.forEach((header, colIndex) => {
                        const cellValue = row[colIndex] || '';
                        html += `<td class="px-3 py-2 border text-gray-600">${cellValue}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';

                previewContainer.innerHTML = html;
            }

            renderFieldMapping() {
                const mappingContainer = document.getElementById('field-mapping-list');

                if (!this.collectionTemplate || this.collectionTemplate.length === 0) {
                    mappingContainer.innerHTML = `
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                <span class="text-yellow-800">
                                    No template fields defined for this collection. 
                                    <button onclick="window.cmsApp.hideImportModal(); window.cmsApp.showCollectionSettings();" 
                                            class="text-blue-600 underline ml-1">
                                        Configure template first
                                    </button>
                                </span>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = '';
                this.collectionTemplate.forEach(templateField => {
                    const mappingKey = `mapping-${templateField.name}`;
                    const currentMapping = this.fieldMapping[templateField.name] || '';

                    html += `
                        <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                            <div class="w-48">
                                <label class="block text-sm font-medium text-gray-700">
                                    ${templateField.displayName} 
                                    <span class="text-red-600">*</span>
                                </label>
                                <span class="text-xs text-gray-500">(${templateField.name} - ${templateField.type})</span>
                            </div>
                            <div class="flex-1">
                                <select id="${mappingKey}" 
                                        onchange="window.cmsApp.updateFieldMapping('${templateField.name}', this.value)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Select CSV Column --</option>
                                    ${this.csvHeaders.map(header => `
                                        <option value="${header}" ${currentMapping === header ? 'selected' : ''}>
                                            ${header}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                });

                mappingContainer.innerHTML = html;
            }

            updateFieldMapping(templateFieldName, csvHeader) {
                if (csvHeader) {
                    this.fieldMapping[templateFieldName] = csvHeader;
                } else {
                    delete this.fieldMapping[templateFieldName];
                }
            }

            async startImport() {
                // Validate that we have at least one field mapped
                if (Object.keys(this.fieldMapping).length === 0) {
                    this.showStatus('Please map at least one field before importing', 'error');
                    return;
                }

                this.importStep = 3;
                document.getElementById('import-step-2').style.display = 'none';
                document.getElementById('import-step-3').style.display = 'block';
                document.getElementById('import-back-btn').style.display = 'none';
                document.getElementById('import-start-btn').style.display = 'none';

                // Initialize progress
                this.importProgress.total = this.csvRows.length;
                this.importProgress.current = 0;
                this.importProgress.success = 0;
                this.importProgress.errors = 0;
                this.importProgress.errorDetails = [];

                this.updateImportProgress();

                // Start importing
                await this.processImport();
            }

            async processImport() {
                const batchSize = 10; // Process in batches to avoid overwhelming Firestore

                for (let i = 0; i < this.csvRows.length; i += batchSize) {
                    const batch = this.csvRows.slice(i, i + batchSize);

                    await Promise.all(batch.map(async (row, batchIndex) => {
                        const rowIndex = i + batchIndex;
                        try {
                            const documentData = this.parseRowToDocument(row);
                            if (documentData && Object.keys(documentData).length > 0) {
                                await addDoc(collection(db, this.currentCollection.name), documentData);
                                this.importProgress.success++;
                            } else {
                                throw new Error('No valid data found in row');
                            }
                        } catch (error) {
                            this.importProgress.errors++;
                            this.importProgress.errorDetails.push({
                                row: rowIndex + 1,
                                error: error.message
                            });
                        }

                        this.importProgress.current++;
                        this.updateImportProgress();
                    }));

                    // Small delay between batches to prevent rate limiting
                    if (i + batchSize < this.csvRows.length) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // Update collection's lastModified timestamp after import
                await this.updateCollectionLastModified();

                this.completeImport();
            }

            parseRowToDocument(row) {
                const documentData = {};
                let hasData = false;

                Object.entries(this.fieldMapping).forEach(([templateFieldName, csvHeader]) => {
                    const csvColumnIndex = this.csvHeaders.indexOf(csvHeader);
                    if (csvColumnIndex >= 0) {
                        const cellValue = row[csvColumnIndex]?.trim() || '';

                        if (cellValue) {
                            const templateField = this.collectionTemplate.find(f => f.name === templateFieldName);
                            const parsedValue = this.parseCellValue(cellValue, templateField.type);
                            if (parsedValue !== null) {
                                documentData[templateFieldName] = parsedValue;
                                hasData = true;
                            }
                        }
                    }
                });

                return hasData ? documentData : null;
            }

            parseCellValue(cellValue, fieldType) {
                if (!cellValue || cellValue.toLowerCase() === 'null') {
                    return null;
                }

                try {
                    switch (fieldType) {
                        case 'string':
                        case 'dropdown':
                            return cellValue;

                        case 'number':
                            const num = parseFloat(cellValue);
                            if (isNaN(num)) throw new Error(`Invalid number: ${cellValue}`);
                            return num;

                        case 'boolean':
                            const lowerValue = cellValue.toLowerCase();
                            if (['true', 'yes', '1'].includes(lowerValue)) return true;
                            if (['false', 'no', '0'].includes(lowerValue)) return false;
                            throw new Error(`Invalid boolean: ${cellValue}`);

                        case 'timestamp':
                            const date = new Date(cellValue);
                            if (isNaN(date.getTime())) throw new Error(`Invalid date: ${cellValue}`);
                            return Timestamp.fromDate(date);

                        case 'array':
                            // Try JSON first, then comma-separated
                            if (cellValue.startsWith('[') && cellValue.endsWith(']')) {
                                return JSON.parse(cellValue);
                            } else {
                                return cellValue.split(',').map(item => item.trim()).filter(item => item);
                            }

                        case 'map':
                            return JSON.parse(cellValue);

                        case 'geopoint':
                            // Expect "lat,lng" format
                            const coords = cellValue.split(',').map(coord => parseFloat(coord.trim()));
                            if (coords.length !== 2 || coords.some(isNaN)) {
                                throw new Error(`Invalid geopoint: ${cellValue}`);
                            }
                            return new GeoPoint(coords[0], coords[1]);

                        case 'reference':
                            return { path: cellValue };

                        default:
                            return cellValue;
                    }
                } catch (error) {
                    throw new Error(`Error parsing ${fieldType}: ${error.message}`);
                }
            }

            updateImportProgress() {
                const percentage = this.importProgress.total > 0 ?
                    (this.importProgress.current / this.importProgress.total) * 100 : 0;

                document.getElementById('import-progress-bar').style.width = `${percentage}%`;
                document.getElementById('import-progress-text').textContent =
                    `${this.importProgress.current} / ${this.importProgress.total}`;

                document.querySelector('#import-success-count span.font-medium').textContent =
                    this.importProgress.success;
                document.querySelector('#import-error-count span.font-medium').textContent =
                    this.importProgress.errors;

                // Show errors if any
                if (this.importProgress.errors > 0) {
                    document.getElementById('import-errors').classList.remove('hidden');
                    const errorsList = document.getElementById('import-errors-list');
                    errorsList.innerHTML = this.importProgress.errorDetails.map(error =>
                        `<div class="text-sm text-red-700">Row ${error.row}: ${error.error}</div>`
                    ).join('');
                }
            }

            completeImport() {
                document.getElementById('import-complete').classList.remove('hidden');
                document.getElementById('import-finish-btn').style.display = 'inline-block';

                this.showStatus(
                    `Import completed! ${this.importProgress.success} documents imported successfully.`,
                    this.importProgress.errors > 0 ? 'info' : 'success'
                );
            }

            async finishImport() {
                this.hideImportModal();
                // Refresh the collection view to show imported documents
                await this.selectCollection(this.currentCollection.id);
            }

            async updateCollectionLastModified() {
                try {
                    await updateDoc(doc(db, CMS_CONFIG.trackerCollection, this.currentCollection.id), {
                        lastModified: new Date().toISOString()
                    });

                    // Update local collection object
                    this.currentCollection.lastModified = new Date().toISOString();

                    // Also update in collections array
                    const collIndex = this.collections.findIndex(c => c.id === this.currentCollection.id);
                    if (collIndex !== -1) {
                        this.collections[collIndex].lastModified = this.currentCollection.lastModified;
                    }
                } catch (error) {
                    console.error('Error updating collection lastModified:', error);
                    // Don't show error to user as it's not critical
                }
            }

            toggleDocumentSelection(docId, isSelected) {
                if (isSelected) {
                    this.selectedDocuments.add(docId);
                } else {
                    this.selectedDocuments.delete(docId);
                }
                this.renderTable();
            }

            toggleSelectAll(selectAll) {
                if (selectAll) {
                    // Select all non-placeholder documents
                    this.filteredDocuments.forEach(doc => {
                        this.selectedDocuments.add(doc.id);
                    });
                } else {
                    // Deselect all
                    this.selectedDocuments.clear();
                }
                this.renderTable();
            }

            isAllSelected() {
                if (this.filteredDocuments.length === 0) return false;
                return this.filteredDocuments.every(doc => this.selectedDocuments.has(doc.id));
            }

            isIndeterminate() {
                const selectedCount = this.selectedDocuments.size;
                return selectedCount > 0 && selectedCount < this.filteredDocuments.length;
            }

            clearSelection() {
                this.selectedDocuments.clear();
                this.renderTable();
            }

            async batchDeleteDocuments() {
                const selectedCount = this.selectedDocuments.size;
                const selectedIds = Array.from(this.selectedDocuments);

                if (selectedCount === 0) return;

                // Check if we're deleting all documents
                const totalDocuments = this.documents.length;
                const willDeleteCollection = selectedCount === totalDocuments;

                let confirmMessage = `Are you sure you want to delete ${selectedCount} document${selectedCount !== 1 ? 's' : ''}? This action cannot be undone.`;

                if (willDeleteCollection) {
                    confirmMessage = `You are about to delete all documents in the collection "${this.currentCollection.name}". This will also remove the entire collection from the CMS.\n\nAre you sure you want to proceed?`;
                }

                if (!confirm(confirmMessage)) return;

                try {
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];

                    // Show progress for large batches
                    if (selectedCount > 5) {
                        this.showStatus(`Deleting ${selectedCount} documents...`, 'info');
                    }

                    // Delete documents in smaller batches to avoid overwhelming Firestore
                    const batchSize = 5;
                    for (let i = 0; i < selectedIds.length; i += batchSize) {
                        const batch = selectedIds.slice(i, i + batchSize);

                        await Promise.all(batch.map(async (docId) => {
                            try {
                                const docRef = doc(db, this.currentCollection.name, docId);
                                await deleteDoc(docRef);
                                successCount++;
                            } catch (error) {
                                errorCount++;
                                errors.push(`${docId}: ${error.message}`);
                            }
                        }));

                        // Small delay between batches
                        if (i + batchSize < selectedIds.length) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }

                    // Update collection's lastModified timestamp
                    await this.updateCollectionLastModified();

                    // Clear selection
                    this.selectedDocuments.clear();

                    if (willDeleteCollection && successCount === totalDocuments) {
                        // All documents were deleted - collection will be auto-removed
                        await this.removeCollectionFromTracker();
                        this.showStatus('All documents deleted. Collection has been removed.', 'success');
                        this.backToCollections();
                        await this.loadCollections();
                    } else {
                        // Show results
                        if (errorCount === 0) {
                            this.showStatus(`Successfully deleted ${successCount} document${successCount !== 1 ? 's' : ''}!`, 'success');
                        } else {
                            this.showStatus(`Deleted ${successCount} documents. ${errorCount} failed.`, 'info');
                            console.error('Batch delete errors:', errors);
                        }

                        // Refresh the collection view
                        await this.selectCollection(this.currentCollection.id);
                    }

                } catch (error) {
                    this.showStatus('Error during batch delete: ' + error.message, 'error');
                }
            }
        }
    </script>
</body>

</html>